

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="X-UA-Compatible" content="IE=edge">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:title" content="Jina Documentation">
<meta property="og:description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:url" content="https://opensource.jina.ai">
<meta property="og:image" content="../../_static/banner.png">
<meta property="og:type" content="website">
<link rel="icon" href="../../_static/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>Common Design Patterns &mdash; Jina 1.0.1-master documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/main.css" type="text/css" />


  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Multi-modal and Cross-modal Search in Jina" href="../cross-multi-modality/index.html" />
    <link rel="prev" title="Understand Jina Recursive Document Representation" href="../traversal/index.html" /> 
</head>

<body class="wy-body-for-nav">
  <div id="showhide-navbar-btn" onclick="showhide_navbar();"></div>

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://docs.jina.ai">
          

          
            
            <img src="../../_static/jina-prod-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            

          <div class="dropdown version">
            <button class="dropbtn version">1.0.1-master</button>
            <div class="dropdown-content">
              
              <a class="dropdown-item" href="/master">master</a>
              
              <a class="dropdown-item" href="/v0.9.28">0.9.28</a>
              
              <a class="dropdown-item" href="/v0.9.23">0.9.23</a>
              
              <a class="dropdown-item" href="/v0.9.22">0.9.22</a>
              
              <a class="dropdown-item" href="/v0.9.21">0.9.21</a>
              
              <a class="dropdown-item" href="/v0.9.20">0.9.20</a>
              
              <a class="dropdown-item" href="/v0.9.19">0.9.19</a>
              
              <a class="dropdown-item" href="/v0.9.18">0.9.18</a>
              
              <a class="dropdown-item" href="/v0.9.17">0.9.17</a>
              
              <a class="dropdown-item" href="/v0.9.16">0.9.16</a>
              
              <a class="dropdown-item" href="/v0.9.15">0.9.15</a>
              
              <a class="dropdown-item" href="/v0.9.14">0.9.14</a>
              
              <a class="dropdown-item" href="/v0.9.13">0.9.13</a>
              
              <a class="dropdown-item" href="/v0.9.12">0.9.12</a>
              
              <a class="dropdown-item" href="/v0.9.11">0.9.11</a>
              
              <a class="dropdown-item" href="/v0.9.10">0.9.10</a>
              
              <a class="dropdown-item" href="/v0.9.9">0.9.9</a>
              
              <a class="dropdown-item" href="/v0.9.8">0.9.8</a>
              
              <a class="dropdown-item" href="/v0.9.7">0.9.7</a>
              
              <a class="dropdown-item" href="/v0.9.6">0.9.6</a>
              
              <a class="dropdown-item" href="/v0.9.5">0.9.5</a>
              
              <a class="dropdown-item" href="/v0.9.3">0.9.3</a>
              
              <a class="dropdown-item" href="/v0.9.2">0.9.2</a>
              
              <a class="dropdown-item" href="/v0.9.1">0.9.1</a>
              
              <a class="dropdown-item" href="/v0.9.0">0.9.0</a>
              
              <a class="dropdown-item" href="/v0.8.22">0.8.22</a>
              
              <a class="dropdown-item" href="/v0.8.21">0.8.21</a>
              
            </div>
          </div>
            
          


          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/os/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../helloworld/index.html">Jina ‚ÄúHello, World!‚Äù üëãüåç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../101/index.html">Jina 101: First Thing to Learn About Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Using Flow API to Compose Your Jina Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../io/index.html">Input and Output Functions in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cli/exit.html">Gracefully Exit Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../project-guide/project-guide.html">Project set up guide</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cli/index.html">Jina Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/jina.html">Jina Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yaml/index.html">Jina YAML Syntax Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proto/index.html">Jina Protobuf Specification</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../traversal/index.html">Understand Jina Recursive Document Representation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Common Design Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cross-multi-modality/index.html">Multi-modal and Cross-modal Search in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hub/index.html">Using Jina Pod with Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/index.html">Using Jina Pod Remotely</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logging/index.html">Logging configuration in jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dashboard/index.html">Jina Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../simple_exec.html">Built-in Simple Executors and Reserved <code class="docutils literal notranslate"><span class="pre">uses</span></code> in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../restapi/index.html">Jina REST API Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../envs.html">OS Environment Variables Used in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prevent_duplicate_indexing/index.html">Prevent Indexing Duplicates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incremental_indexing/index.html">Incremental Indexing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crud/index.html">CRUD Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimization/index.html">Flow Optimization</a></li>
</ul>
<p class="caption"><span class="caption-text">Extensions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../extend/executor.html">Guideline When Adding New Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extend/mwu.html">A Minimum Working Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extend/driver.html">Guideline When Adding New Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hub/publish-your-pod-image.html">Publish Your Pod Image to Jina Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_schema.html">Jina API Schema for 3rd-Party Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary/glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html">Contributing to Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING.html#join-us-on-slack">Join Us on Slack!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RELEASE.html">Release &amp; Version Identifier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Change Logs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jep/index.html">Jina Enhancement Proposals (JEP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/dev.html">FAQ for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/user.html">FAQ for End-Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../docstring/docstring.html">Docstring guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../all_exec.html">List of 57 Executors in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../all_driver.html">List of 63 Drivers in Jina</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Jina</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation" class="nav-bar-header">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Common Design Patterns</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  
<div role="search" class="nav-bar-search">
  <form id="rtd-search-form" class="wy-form doc-searchbox" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs (Press / to focus)" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

</div>
<hr/>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="common-design-patterns">
<h1>Common Design Patterns<a class="headerlink" href="#common-design-patterns" title="Permalink to this headline">¬∂</a></h1>
<p>Jina is a really flexible AI-powered neural search framework and is designed to enable any pattern that can be framed as a neural search problem. However, there are basic common patterns that show up when developing search solutions with Jina:</p>
<div class="section" id="compoundindexer-vector-kv-indexers">
<h2>CompoundIndexer (Vector + KV Indexers)<a class="headerlink" href="#compoundindexer-vector-kv-indexers" title="Permalink to this headline">¬∂</a></h2>
<p>For neural search applications, it helps to use a <code class="docutils literal notranslate"><span class="pre">CompoundIndexer</span></code> in the same Pod for both the index and query Flows. The following YAML file shows an example of this pattern:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!CompoundIndexer</span>
<span class="nt">components</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="kt">!NumpyIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vectors.gz</span>
      <span class="nt">metric</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cosine</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecIndexer</span>
  <span class="p p-Indicator">-</span> <span class="kt">!BinaryPbIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">values.gz</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kvIndexer</span>  <span class="c1"># a customized name</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">complete indexer</span>
</pre></div>
</div>
<p>The above YAML creates a Flow that:</p>
<ul class="simple">
<li><p>Acts as a single indexer</p></li>
<li><p>Lets you seamlessly query the index with the embedding vector from any upstream encoder</p></li>
<li><p>Returns the binary information in the key-value index in the Pod‚Äôs response message.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">VectorIndexer</span></code>:</p>
<ul class="simple">
<li><p>Retrieves the most relevant Documents by finding similarities in the embedding space</p></li>
<li><p>Uses the key-value index to extract meaningful data and fields from those Documents</p></li>
</ul>
</div>
<div class="section" id="text-document-segmentation">
<h2>Text Document Segmentation<a class="headerlink" href="#text-document-segmentation" title="Permalink to this headline">¬∂</a></h2>
<p>A common search pattern is storing long text documents in an index to retrieve them later using short sentences. A single embedding vector per long text document is not the proper way to do this: It makes it hard to extract a single semantically-meaningful vector from a long document. Jina solves this by introducing <a class="reference external" href="https://github.com/jina-ai/jina/tree/master/docs/chapters/101#document--chunk">Chunks</a>. The common scenario is to have a <code class="docutils literal notranslate"><span class="pre">segmenter</span></code> segmenting the document into smaller parts (typically short sentences) followed by an NLP-based encoder.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Sentencizer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">min_sent_len</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
  <span class="nt">max_sent_len</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">64</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!TransformerTorchEncoder</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">pretrained_model_name_or_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">distilbert-base-cased</span>
  <span class="nt">max_length</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">96</span>
</pre></div>
</div>
<p>This way a single document contains <code class="docutils literal notranslate"><span class="pre">N</span></code> different Chunks that are later independently encoded by a downstream encoder. This lets Jina query the index using a short sentence as input, where similarity search can be applied to find the most common Chunks. This way the same Document can be retrieved based on searching different parts of it.</p>
<p>For instance, a text document containing 3 sentences can be decomposed into 3 Chunks:</p>
<p><code class="docutils literal notranslate"><span class="pre">Someone</span> <span class="pre">is</span> <span class="pre">waiting</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">bus</span> <span class="pre">stop.</span> <span class="pre">John</span> <span class="pre">looks</span> <span class="pre">surprised,</span> <span class="pre">his</span> <span class="pre">face</span> <span class="pre">seems</span> <span class="pre">familiar</span></code> -&gt;
[<code class="docutils literal notranslate"><span class="pre">Someone</span> <span class="pre">is</span> <span class="pre">waiting</span> <span class="pre">at</span> <span class="pre">the</span> <span class="pre">bus</span> <span class="pre">stop</span></code>, <code class="docutils literal notranslate"><span class="pre">John</span> <span class="pre">looks</span> <span class="pre">surprised</span></code>, <code class="docutils literal notranslate"><span class="pre">his</span> <span class="pre">face</span> <span class="pre">seems</span> <span class="pre">familiar</span></code>]</p>
<p>This lets us retrieve the Document from different <code class="docutils literal notranslate"><span class="pre">input</span></code> sentences that match any of these 3 parts. For instance, these 3 different inputs could lead to the extraction of the same document by targeting 3 different Chunks:</p>
<ul class="simple">
<li><p>A standing guy -&gt; Someone is waiting at the bus stop.</p></li>
<li><p>He is amazed` -&gt; John looks surprised.</p></li>
<li><p>a similar look -&gt; his face seems familiar.</p></li>
</ul>
</div>
<div class="section" id="indexers-at-different-granularity-levels">
<h2>Indexers at Different Granularity Levels<a class="headerlink" href="#indexers-at-different-granularity-levels" title="Permalink to this headline">¬∂</a></h2>
<p>In a configuration like the one for <em>Text Document Segmentation</em>, we need different levels of indexing. The system needs to keep the data related to the Chunks as well as the information of the original documents. This way:</p>
<ol class="simple">
<li><p>The actual search is performed at the Chunk level following the <code class="docutils literal notranslate"><span class="pre">CompoundIndexer</span></code> pattern.</p></li>
<li><p>Then the Document indexer works as a final step to extract the actual Documents expected by the user.</p></li>
</ol>
<p>To implement this, two common structures appear in <code class="docutils literal notranslate"><span class="pre">index</span></code> and <code class="docutils literal notranslate"><span class="pre">query</span></code>. In an <code class="docutils literal notranslate"><span class="pre">index</span></code> flow, these two indexers work in parallel (requests are sent to both indexes at the same time):</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">chunk</span> <span class="pre">indexer</span></code> gets messages from an <code class="docutils literal notranslate"><span class="pre">encoder</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">indexer</span></code> can get the documents even from the <code class="docutils literal notranslate"><span class="pre">gateway</span></code>.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Flow</span>
<span class="nt">pods</span><span class="p">:</span>
  <span class="nt">encoder</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BaseEncoder</span>
  <span class="nt">chunk_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CompoundIndexer</span>
  <span class="nt">doc_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BinaryPbIndexer</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gateway</span>
  <span class="nt">join_all</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">_pass</span>
    <span class="nt">needs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">doc_indexer</span><span class="p p-Indicator">,</span> <span class="nv">chunk_indexer</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>However, at query time the Document and Chunk indexers work sequentially. Normally the Document would get messages from the Chunk indexer with a <code class="docutils literal notranslate"><span class="pre">Chunk2DocRanker</span></code> Pod in the middle of the Flow. The <code class="docutils literal notranslate"><span class="pre">ranker</span></code> would rank the Chunks by relevance and reduce the results to the parent IDs, enabling the <code class="docutils literal notranslate"><span class="pre">doc</span> <span class="pre">indexer</span></code> to extract the original Document‚Äôs binary information.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!Flow</span>
  <span class="nt">encoder</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BaseEncoder</span>
  <span class="nt">chunk_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CompoundIndexer</span>
  <span class="nt">ranker</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Chunk2DocRanker</span>
  <span class="nt">doc_indexer</span><span class="p">:</span>
    <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">BinaryPbIndexer</span>
</pre></div>
</div>
</div>
<div class="section" id="switch-vector-indexer-at-query-time">
<h2>Switch Vector Indexer at Query Time<a class="headerlink" href="#switch-vector-indexer-at-query-time" title="Permalink to this headline">¬∂</a></h2>
<p>Jina lets you decide which kind of vector index to use when exposing the system to be queried. Almost all of Jina‚Äôs advanced vector indexers inherit from <code class="docutils literal notranslate"><span class="pre">BaseNumpyIndexer</span></code>. These classes only override methods related to querying the index, but not the ones related to storing vectors, meaning they all store vectors in the same format. Jina takes advantage of this, and has the flexibility to offer the same vector data in different vector indexer types. To implement this functionality there are two things to consider, one for indexing and one for querying.</p>
<div class="section" id="indexing">
<h3>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¬∂</a></h3>
<p>At index time, we use <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code>. It is important that the <code class="docutils literal notranslate"><span class="pre">Pod</span></code> containing this Executor ensures <code class="docutils literal notranslate"><span class="pre">read_only:</span> <span class="pre">False</span></code>. This way, the same indexer can be reconstructed from binary form, which contains information of the vectors (dimensions, ‚Ä¶) that are needed to have it work at query time.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!NumpyIndexer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">index_filename</span><span class="p">:</span> <span class="s">&#39;vec.gz&#39;</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wrapidx</span>
</pre></div>
</div>
</div>
<div class="section" id="querying">
<h3>Querying<a class="headerlink" href="#querying" title="Permalink to this headline">¬∂</a></h3>
<p>At query time, we use <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code> as <code class="docutils literal notranslate"><span class="pre">ref_indexer</span></code> for any advanced indexer inheriting from <code class="docutils literal notranslate"><span class="pre">BaseNumpyIndexer</span></code> (see <code class="docutils literal notranslate"><span class="pre">AnnoyIndexer</span></code>, <code class="docutils literal notranslate"><span class="pre">FaissIndexer</span></code>, ‚Ä¶).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!FaissIndexer</span>
<span class="nt">with</span><span class="p">:</span>
  <span class="nt">ref_indexer</span><span class="p">:</span>
    <span class="kt">!NumpyIndexer</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">wrapidx</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="s">&#39;vec.gz&#39;</span>
</pre></div>
</div>
<p>In this case, this construction lets the <code class="docutils literal notranslate"><span class="pre">FaissIndexer</span></code> use the <code class="docutils literal notranslate"><span class="pre">vectors</span></code> stored by the indexer named <code class="docutils literal notranslate"><span class="pre">wrapidx</span></code>.</p>
</div>
</div>
<div class="section" id="override-parameters-using-queryset">
<h2>Override parameters using QuerySet<a class="headerlink" href="#override-parameters-using-queryset" title="Permalink to this headline">¬∂</a></h2>
<p>We can override parameter values in flows with the help of <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code>. <code class="docutils literal notranslate"><span class="pre">querySet</span></code> is a set of <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> protobuf messages that can be sent along with any <code class="docutils literal notranslate"><span class="pre">Request</span></code>. It is useful to dynamically override parameters of a driver for a specific request. (Not every parameter is able to be overriden)</p>
<p>This <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> has 3 main fields:</p>
<ul class="simple">
<li><p>name: A name of the driver that will be overriden (the exact class name). For now any driver in the Flow of this class will be affected by this <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code></p></li>
<li><p>parameters: A key-value map where the key is the parameter to be overriden and the value the value that it will be used in the request</p></li>
<li><p>priority: The priority this <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> has with respect to potential defaults of the driver.</p></li>
</ul>
<p>For a driver to be able to override its parameters and read from the <code class="docutils literal notranslate"><span class="pre">QueryLang</span></code> messages it needs to do 2 things:</p>
<ul class="simple">
<li><p>Implement <code class="docutils literal notranslate"><span class="pre">QuerySetReader</span></code> as a <code class="docutils literal notranslate"><span class="pre">mix-in</span></code> class</p></li>
<li><p>Declare the attribute with an underscore prefix, i.e (<code class="docutils literal notranslate"><span class="pre">self._top_k</span></code> to have <code class="docutils literal notranslate"><span class="pre">top_k</span></code> as an attribute with the potential to be overriden)</p></li>
</ul>
<p>Suppose we want to override <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver's</span></code> top_k value of 10 with 20 in the below pod. We can see that <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code> fullfills the requirements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VectorSearchDriver</span><span class="p">(</span><span class="n">QuerySetReader</span><span class="p">,</span> <span class="n">BaseSearchDriver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">fill_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_top_k</span> <span class="o">=</span> <span class="n">top_k</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>The pod is defined as taking 10 for its <code class="docutils literal notranslate"><span class="pre">top_k</span></code> parameter in the <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="kt">!CompoundIndexer</span>
<span class="nt">components</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="kt">!NumpyIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vec.gz</span>
      <span class="nt">metric</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cosine</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
  <span class="p p-Indicator">-</span> <span class="kt">!BinaryPbIndexer</span>
    <span class="nt">with</span><span class="p">:</span>
      <span class="nt">index_filename</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">doc.gz</span>
    <span class="nt">metas</span><span class="p">:</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
<span class="nt">metas</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">chunk_indexer</span>
  <span class="nt">workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">$JINA_WORKSPACE</span>
<span class="nt">requests</span><span class="p">:</span>
  <span class="nt">on</span><span class="p">:</span>
    <span class="nt">IndexRequest</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="kt">!VectorIndexDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span> <span class="kt">!KVIndexDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">[</span><span class="nv">SearchRequest</span><span class="p p-Indicator">]:</span>
      <span class="p p-Indicator">-</span> <span class="kt">!VectorSearchDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">vecidx</span>
          <span class="nt">top_k</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;r&#39;</span><span class="p p-Indicator">]</span>
      <span class="p p-Indicator">-</span> <span class="kt">!KVSearchDriver</span>
        <span class="nt">with</span><span class="p">:</span>
          <span class="nt">executor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docidx</span>
          <span class="nt">traversal_paths</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;m&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>We construct a queryset <code class="docutils literal notranslate"><span class="pre">top_k_queryset</span></code> which defines to use a top_k value of 20 for <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="n">top_k_queryset</span> <span class="o">=</span> <span class="n">jina_pb2</span><span class="o">.</span><span class="n">QueryLang</span><span class="p">()</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;VectorSearchDriver&#39;</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">top_k_queryset</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;top_k&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
<p>Passing <code class="docutils literal notranslate"><span class="pre">top_k_queryset</span></code> to <code class="docutils literal notranslate"><span class="pre">flow.search</span></code> will override <code class="docutils literal notranslate"><span class="pre">top_k</span></code> value of <code class="docutils literal notranslate"><span class="pre">10</span></code> with <code class="docutils literal notranslate"><span class="pre">20</span></code> in the <code class="docutils literal notranslate"><span class="pre">VectorSearchDriver</span></code>.
Note that more than one <code class="docutils literal notranslate"><span class="pre">queryset</span></code> can be passed with any request.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">Flow</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="s1">&#39;flow.yml&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">search_flow</span><span class="p">:</span>
        <span class="n">search_flow</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">input_fn</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span> <span class="n">on_done</span><span class="o">=</span><span class="n">print_results</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="p">[</span><span class="n">top_k_queryset</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="the-score-field">
<h2>The Score Field<a class="headerlink" href="#the-score-field" title="Permalink to this headline">¬∂</a></h2>
<p>In ranking document matches, Jina uses several algorithms to compute the <em>relevance</em> of a document given a specific query. This is stored as a numeric value in the <code class="docutils literal notranslate"><span class="pre">score</span></code> field of a <code class="docutils literal notranslate"><span class="pre">match</span></code>, both at a <code class="docutils literal notranslate"><span class="pre">document</span></code> level and at the <code class="docutils literal notranslate"><span class="pre">chunk</span></code> level. This field can mean either ‚Äúsmaller is better‚Äù (<em>distance</em>) or ‚Äúlarger is better‚Äù (<em>similarity</em>, <em>relevance</em>).</p>
<p>As, an example, the <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code> uses k-NN (with various distance metrics) to calculate a <em>distance</em>, thus ‚Äúsmaller is better‚Äù. On the other hand, the <code class="docutils literal notranslate"><span class="pre">SimpleAggregateRanker</span></code> uses the function <em>1/(1+s)</em> when using <code class="docutils literal notranslate"><span class="pre">min</span></code> as <code class="docutils literal notranslate"><span class="pre">aggregate_function</span></code> (where <em>s</em> is the min. score from all <code class="docutils literal notranslate"><span class="pre">chunks</span></code>) in order to ‚Äúbubble up‚Äù the score from child <code class="docutils literal notranslate"><span class="pre">chunks</span></code> to the parent, thus ‚Äúlarger is better‚Äù. There can be other metrics too.</p>
<p>This can pe problematic when deciding how to sort the results from a query. Fortunately, Jina provides the name of the operator that has performed the scoring:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/**
 * Represents the relevance model to `ref_id`
 */
message NamedScore {
    float value = 1; // value
    string op_name = 2; // the name of the operator/score function
    ...
}
</pre></div>
</div>
<p>Notice the field <code class="docutils literal notranslate"><span class="pre">op_name</span></code> in the above. As the comment suggests, this is the name of the operator that has performed the sorting (e.g. <code class="docutils literal notranslate"><span class="pre">NumpyIndexer</span></code>, or <code class="docutils literal notranslate"><span class="pre">SimpleAggregateRanker</span></code>). Based on this, the <code class="docutils literal notranslate"><span class="pre">value</span></code> field is either of type ‚Äúsmaller is better‚Äù or of type ‚Äúlarger is better‚Äù.</p>
<p><strong>Conclusion</strong>: When sorting results, make sure you check the <code class="docutils literal notranslate"><span class="pre">document.score.op_name</span></code> in order to understand the direction of the score.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
        <a href="../cross-multi-modality/index.html" class="btn btn-neutral float-right" title="Multi-modal and Cross-modal Search in Jina"
           accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
        
        
        <a href="../traversal/index.html" class="btn btn-neutral float-left" title="Understand Jina Recursive Document Representation"
           accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
        
    </div>
    

    <hr/>

    <div role="contentinfo">
        <nav class="devsite-footer-linkboxes nocontent" aria-label="Footer links">

            <ul class="devsite-footer-linkboxes-list">

                <li class="devsite-footer-linkbox ">
                    <h3 class="devsite-footer-linkbox-heading no-link">Stay connected</h3>
                    <ul class="devsite-footer-linkbox-list">

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">

                                <i class="fab fa-github"></i> GitHub

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://www.linkedin.com/company/jinaai/" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">

                                <i class="fab fa-linkedin"></i> LinkedIn

                            </a>

                        </li>



                        <li class="devsite-footer-linkbox-item">

                            <a href="https://twitter.com/JinaAI_" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">

                                <i class="fab fa-twitter"></i> Twitter

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://www.youtube.com/c/JinaAI" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">

                                <i class="fab fa-youtube"></i> YouTube

                            </a>

                        </li>

                    </ul>
                </li>

                <li class="devsite-footer-linkbox ">
                    <h3 class="devsite-footer-linkbox-heading no-link">Support</h3>
                    <ul class="devsite-footer-linkbox-list">
                        <li class="devsite-footer-linkbox-item">

                            <a href="https://slack.jina.ai"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">

                                <i class="fab fa-slack"></i> Slack community

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina/issues"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">

                                Issue tracker

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina/blob/master/CHANGELOG.md"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">

                                Release notes

                            </a>

                        </li>



                        <li class="devsite-footer-linkbox-item">

                            <a href="https://career.jina.ai"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">

                                Career@Jina AI

                            </a>

                        </li>


                    </ul>
                </li>

            </ul>

        </nav>
        <p>
            
            &copy; Copyright Jina AI Limited. All rights reserved.
            <span class="lastupdated">
        Last updated on Feb 10, 2021.
      </span>

        </p>
    </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });

      function showhide_navbar() {
      var x = document.getElementsByClassName("wy-nav-side")[0];
      var y = document.getElementsByClassName("wy-nav-content-wrap")[0];
      var z = document.getElementById("showhide-navbar-btn");
      if (x.style.display === "none") {
        x.style.display = "block";
        y.style.marginLeft = "300px";
        z.style.left = "300px";
      } else {
        x.style.display = "none";
        y.style.marginLeft = "0";
        z.style.left = "0px";
      }
    }

  </script>

  <!-- Search box becomes active when you press the slash(/) key anywhere on the page-->
  <script>
    const body = document.querySelector('body');
    const searchBox = document.querySelector('form').querySelector('input[type="text"]');

    body.addEventListener('keyup', event => {
      event.preventDefault()
      if (event.key === '/') {
        searchBox.focus();
      }
    });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-164627626-3', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>
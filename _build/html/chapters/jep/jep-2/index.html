

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="X-UA-Compatible" content="IE=edge">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@JinaAI_">
<meta name="twitter:creator" content="@JinaAI_">
<meta name="description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:title" content="Jina Documentation">
<meta property="og:description"
      content="Jina is the cloud-native neural search solution powered by the state-of-the-art AI and deep learning">
<meta property="og:url" content="https://opensource.jina.ai">
<meta property="og:image" content="../../../_static/banner.png">
<meta property="og:type" content="website">
<link rel="icon" href="../../../_static/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>JEP 2 ‚Äî Supporting Docker Container in Flow API &mdash; Jina 0.9.24 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/main.css" type="text/css" />


  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="JEP 3 ‚Äî Adding support for multi-fields search" href="../jep-3/index.html" />
    <link rel="prev" title="JEP 1 ‚Äî Redesigning Driver and its relation to Executor" href="../jep-1/index.html" /> 
</head>

<body class="wy-body-for-nav">
  <div id="showhide-navbar-btn" onclick="showhide_navbar();"></div>

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://docs.jina.ai">
          

          
            
            <img src="../../../_static/jina-prod-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            

          <div class="dropdown version">
            <button class="dropbtn version">0.9.24</button>
            <div class="dropdown-content">
              
              <a class="dropdown-item" href="/master">master</a>
              
              <a class="dropdown-item" href="/v0.9.21">0.9.21</a>
              
              <a class="dropdown-item" href="/v0.9.20">0.9.20</a>
              
              <a class="dropdown-item" href="/v0.9.19">0.9.19</a>
              
              <a class="dropdown-item" href="/v0.9.18">0.9.18</a>
              
              <a class="dropdown-item" href="/v0.9.17">0.9.17</a>
              
              <a class="dropdown-item" href="/v0.9.16">0.9.16</a>
              
              <a class="dropdown-item" href="/v0.9.15">0.9.15</a>
              
              <a class="dropdown-item" href="/v0.9.14">0.9.14</a>
              
              <a class="dropdown-item" href="/v0.9.13">0.9.13</a>
              
              <a class="dropdown-item" href="/v0.9.12">0.9.12</a>
              
              <a class="dropdown-item" href="/v0.9.11">0.9.11</a>
              
              <a class="dropdown-item" href="/v0.9.10">0.9.10</a>
              
              <a class="dropdown-item" href="/v0.9.9">0.9.9</a>
              
              <a class="dropdown-item" href="/v0.9.8">0.9.8</a>
              
              <a class="dropdown-item" href="/v0.9.7">0.9.7</a>
              
              <a class="dropdown-item" href="/v0.9.6">0.9.6</a>
              
              <a class="dropdown-item" href="/v0.9.5">0.9.5</a>
              
              <a class="dropdown-item" href="/v0.9.3">0.9.3</a>
              
              <a class="dropdown-item" href="/v0.9.2">0.9.2</a>
              
              <a class="dropdown-item" href="/v0.9.1">0.9.1</a>
              
              <a class="dropdown-item" href="/v0.9.0">0.9.0</a>
              
              <a class="dropdown-item" href="/v0.8.22">0.8.22</a>
              
              <a class="dropdown-item" href="/v0.8.21">0.8.21</a>
              
            </div>
          </div>
            
          


          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/os/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helloworld/index.html">Jina ‚ÄúHello, World!‚Äù üëãüåç</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../101/index.html">Jina 101: First Thing to Learn About Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flow/index.html">Using Flow API to Compose Your Jina Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/index.html">Input and Output Functions in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli/exit.html">Gracefully Exit Jina</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cli/index.html">Jina Command-Line Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/jina.html">Jina Python API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../yaml/index.html">Jina YAML Syntax Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../proto/index.html">Jina Protobuf Specification</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../traversal/index.html">Understand Jina Recursive Document Representation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flow/pattern.html">Common Design Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cross-multi-modality/index.html">Multi &amp; Cross Modality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hub/index.html">Using Jina Pod with Docker Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../remote/index.html">Using Jina Pod Remotely</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging/index.html">Logging configuration in jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dashboard/index.html">Using Dashboard to Monitor Logs and View Flow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simple_exec.html">Built-in Simple Executors and Reserved <code class="docutils literal notranslate"><span class="pre">uses</span></code> in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../restapi/index.html">Jina REST API Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../envs.html">OS Environment Variables Used in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../prevent_duplicate_indexing/index.html">Prevent Indexing Duplicates</a></li>
</ul>
<p class="caption"><span class="caption-text">Extensions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../extend/executor.html">Guideline When Adding New Executor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extend/mwu.html">A Minimum Working Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extend/driver.html">Guideline When Adding New Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hub/publish-your-pod-image.html">Publish Your Pod Image to Jina Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_schema.html">Jina API Schema for 3rd-Party Applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Community</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Jina Enhancement Proposals (JEP)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../jep-1/index.html">JEP 1 ‚Äî Redesigning <code class="docutils literal notranslate"><span class="pre">Driver</span></code> and its relation to <code class="docutils literal notranslate"><span class="pre">Executor</span></code></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">JEP 2 ‚Äî Supporting Docker Container in Flow API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jep-3/index.html">JEP 3 ‚Äî Adding support for multi-fields search</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/dev.html">FAQ for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/user.html">FAQ for End-Users</a></li>
</ul>
<p class="caption"><span class="caption-text">Indices and Tables</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../all_exec.html">List of 123 Executors in Jina</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../all_driver.html">List of 62 Drivers in Jina</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Jina</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation" class="nav-bar-header">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Jina Enhancement Proposals (JEP)</a> &raquo;</li>
        
      <li>JEP 2 ‚Äî Supporting Docker Container in Flow API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  
<div role="search" class="nav-bar-search">
  <form id="rtd-search-form" class="wy-form doc-searchbox" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs (Press / to focus)" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

</div>
<hr/>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="jep-2-supporting-docker-container-in-flow-api">
<h1><a class="toc-backref" href="#id14">JEP 2 ‚Äî Supporting Docker Container in Flow API</a><a class="headerlink" href="#jep-2-supporting-docker-container-in-flow-api" title="Permalink to this headline">¬∂</a></h1>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jep-2-supporting-docker-container-in-flow-api" id="id3">JEP 2 ‚Äî Supporting Docker Container in Flow API</a></p>
<ul>
<li><p><a class="reference internal" href="#abstract" id="id4">Abstract</a></p></li>
<li><p><a class="reference internal" href="#motivation" id="id5">Motivation</a></p></li>
<li><p><a class="reference internal" href="#rationale" id="id6">Rationale</a></p>
<ul>
<li><p><a class="reference internal" href="#can-we-support-remote-pod-in-the-flow-api" id="id7">Can we support remote Pod in the Flow API?</a></p></li>
<li><p><a class="reference internal" href="#run-pods-in-their-own-container" id="id8">Run pods in their own container</a></p></li>
<li><p><a class="reference internal" href="#new-cli-argument" id="id9">New CLI argument</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#specification" id="id10">Specification</a></p>
<ul>
<li><p><a class="reference internal" href="#a-minimum-jina-docker-contianer" id="id11">A minimum Jina Docker Contianer</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id2" id="id12">Specification</a></p></li>
<li><p><a class="reference internal" href="#backwards-compatibility" id="id13">Backwards Compatibility</a></p></li>
</ul>
</li>
</ul>
</div>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Han Xiao (<a class="reference external" href="mailto:han&#46;xiao&#37;&#52;&#48;jina&#46;ai">han<span>&#46;</span>xiao<span>&#64;</span>jina<span>&#46;</span>ai</a>)</p>
</dd>
<dt class="field-even">Created</dt>
<dd class="field-even"><p>Feb. 29, 2020</p>
</dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd"><p>Draft</p>
</dd>
<dt class="field-even">Related JEPs</dt>
<dd class="field-even"><p></p></dd>
<dt class="field-odd">Created on Jina VCS version</dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">&#64;c66b4b9</span></code></p>
</dd>
<dt class="field-even">Merged to Jina VCS version</dt>
<dd class="field-even"><p>TBA</p>
</dd>
<dt class="field-odd">Released in Jina version</dt>
<dd class="field-odd"><p>TBA</p>
</dd>
<dt class="field-even">Discussions</dt>
<dd class="field-even"><p><a class="reference external" href="https://github.com/jina-ai/jina/issues/33">https://github.com/jina-ai/jina/issues/33</a></p>
</dd>
</dl>
<div class="contents topic" id="id1">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#jep-2-supporting-docker-container-in-flow-api" id="id14">JEP 2 ‚Äî Supporting Docker Container in Flow API</a></p>
<ul>
<li><p><a class="reference internal" href="#abstract" id="id15">Abstract</a></p></li>
<li><p><a class="reference internal" href="#motivation" id="id16">Motivation</a></p></li>
<li><p><a class="reference internal" href="#rationale" id="id17">Rationale</a></p></li>
<li><p><a class="reference internal" href="#specification" id="id18">Specification</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id19">Specification</a></p></li>
<li><p><a class="reference internal" href="#backwards-compatibility" id="id20">Backwards Compatibility</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="abstract">
<h2><a class="toc-backref" href="#id15">Abstract</a><a class="headerlink" href="#abstract" title="Permalink to this headline">¬∂</a></h2>
<p>We describe why and how we make <code class="xref py py-mod docutils literal notranslate"><span class="pre">jina.flow</span></code> to support Docker container.</p>
</div>
<div class="section" id="motivation">
<h2><a class="toc-backref" href="#id16">Motivation</a><a class="headerlink" href="#motivation" title="Permalink to this headline">¬∂</a></h2>
<p><code class="xref py py-mod docutils literal notranslate"><span class="pre">jina.flow</span></code> serves as the primary interface for Jina‚Äôs new users. It provides a set of friendly, easy-to-use API to organize a flow of microservices (aka, <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.peapods.pod.Pod</span></code>). It also provides basic orchestration abilities, such as start, scale up, flow pruning and terminate. This saves user quite some time as they would otherwise launch each <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.peapods.pod.Pod</span></code> and connect them manually.</p>
<p>In the current version, <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code> supports <code class="xref py py-func docutils literal notranslate"><span class="pre">jina.flow.Flow.add()</span></code> to allow user to define their own ‚Äúgraph‚Äù by specifying <code class="docutils literal notranslate"><span class="pre">send_to</span></code>, <code class="docutils literal notranslate"><span class="pre">recv_from</span></code>. The <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code> later uses <code class="xref py py-func docutils literal notranslate"><span class="pre">jina.flow.Flow.build()</span></code> method and connects all the <code class="docutils literal notranslate"><span class="pre">Pod</span></code> together. All sockets assignment are hidden from the user perspective.</p>
<p>One of the big limitations of the current <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code> is it does not support containerization, either partial or wholly. Imagine a user needs to run a <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.peapods.pod.Pod</span></code> in a container because of the complicated dependencies it relies on. The current <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code> can not do that. All <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.peapods.pod.Pod</span></code> are either run as a thread or process. This is in fact a common requirement as most of the DL/AI libraries do require specific versions of the DL package or complicated dependencies. Promoting the idea of ‚ÄúModel-as-Docker‚Äù and encouraging users to adapt to this idea not only solves the dependency issue, but also serves as preliminary education to our Jina Hub.</p>
</div>
<div class="section" id="rationale">
<h2><a class="toc-backref" href="#id17">Rationale</a><a class="headerlink" href="#rationale" title="Permalink to this headline">¬∂</a></h2>
<p>To add containerization feature to the <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code>, we first need to understand what are the common use cases.</p>
<ul class="simple">
<li><dl class="simple">
<dt>All pods run outside of the container locally;</dt><dd><p>This is already supported in the current version</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>All pods run outside of the container remotely;</dt><dd><p>This should be supported but not tested. For the sake of security, this should not be encouraged.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Some pods run outside of the container;</dt><dd><p>This is a common use case, either locally or remotely.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>All pods run inside of <strong>one</strong> container;</dt><dd><p>No clear usage. May need to design the API separately</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Each pod runs in its own container;</dt><dd><p>This is a special case of ‚Äúsome pods run outside of the container‚Äù.</p>
</dd>
</dl>
</li>
</ul>
<p>As one can observe from the list, designing an API that allows Pods running locally or remotely, inside or outside the container is the key of this JEP. Imagine we add two new arguments when spawning each pod, <code class="docutils literal notranslate"><span class="pre">host</span></code> and <code class="docutils literal notranslate"><span class="pre">image</span></code>. Note that these two arguments should not be added to the arguments of <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.peapods.pod.Pod</span></code> but to <code class="xref py py-func docutils literal notranslate"><span class="pre">jina.flow.Flow.add()</span></code>.</p>
<div class="section" id="can-we-support-remote-pod-in-the-flow-api">
<h3><a class="toc-backref" href="#id7">Can we support remote Pod in the Flow API?</a><a class="headerlink" href="#can-we-support-remote-pod-in-the-flow-api" title="Permalink to this headline">¬∂</a></h3>
<p>Let‚Äôs first look at <code class="docutils literal notranslate"><span class="pre">host</span></code> argument. Supposedly,</p>
<dl class="confval">
<dt id="confval-host">
<code class="sig-name descname">host</code><a class="headerlink" href="#confval-host" title="Permalink to this definition">¬∂</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">host</span></code> describes the IP address that the added <code class="docutils literal notranslate"><span class="pre">Pod</span></code> will be running on, e.g. <code class="docutils literal notranslate"><span class="pre">192.168.1.20</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<p>One immediate problem is that <code class="xref py py-class docutils literal notranslate"><span class="pre">jina.flow.Flow</span></code> has no way to start this <code class="docutils literal notranslate"><span class="pre">Pod</span></code> remotely on <code class="docutils literal notranslate"><span class="pre">192.168.1.20</span></code>. To achieve, all remote workers need to register themselves or keep a daemon in the background, waiting the ‚Äúmaster‚Äù Flow sending a ‚Äúspawning‚Äù signal to them so they can start. We have no intention to implement such mechanism right now. This is completely out of the scope of the Flow API and seems reinventing the orchestration layer of Kubernetes or Docker Swarm.</p>
<p>Assuming the Pod is started already on the <code class="docutils literal notranslate"><span class="pre">host</span></code>, then writing <code class="docutils literal notranslate"><span class="pre">host</span></code> as an argument of <code class="xref py py-func docutils literal notranslate"><span class="pre">jina.flow.Flow.add()</span></code> can make it accessible to other Pods. This looks true at first, but look at the example below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.0.2&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;192.168.0.3&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="s1">&#39;p2&#39;</span><span class="p">]))</span>  <span class="c1"># -&gt; p3</span>
</pre></div>
</div>
<p>In the example, <cite>p3</cite> is blocking the flow until <cite>p1</cite> and <cite>p2</cite> are all done. <cite>p3</cite> is on the ‚Äúbind‚Äù side, <cite>p1</cite> and <cite>p2</cite> are on the ‚Äúconnect‚Äù side. Therefore, it is in fact <cite>p3</cite> who needs to expose its IP to <cite>p1</cite> and <cite>p2</cite> to make sure <code class="docutils literal notranslate"><span class="pre">p1.host_out</span> <span class="pre">=</span> <span class="pre">p3.host</span></code> and <code class="docutils literal notranslate"><span class="pre">p2.host_out</span> <span class="pre">=</span> <span class="pre">p3.host</span></code>, not in the other way. Simply put, the <code class="docutils literal notranslate"><span class="pre">host</span></code> argument of <cite>p1</cite> and <cite>p2</cite> is useless in this case. Besides that, as <cite>p1</cite> and <cite>p2</cite> are already running in remote (manually), their <code class="docutils literal notranslate"><span class="pre">host_out</span></code> is not changeable by the Flow. This simple use case is not even possible if the Flow can not spawn Pod remotely.</p>
<p>So what can we support? If a remote pod is on the ‚Äúbind‚Äù side, and the local pods are on the ‚Äúconnect‚Äù side, then this works fine. Though in this case we can simply use the existing <code class="docutils literal notranslate"><span class="pre">host_in</span></code>, <code class="docutils literal notranslate"><span class="pre">host_out</span></code>. For example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">)</span>  <span class="c1"># -&gt; p1 running remotely on 192.168.0.2</span>
            <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="n">host_in</span><span class="o">=</span><span class="s1">&#39;192.168.0.2&#39;</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>That is, in the current Flow API a remote pod must be ‚Äúbind‚Äù on both input socket and output socket. Otherwise, its ‚Äúconnect‚Äù socket must be specified with an IP address that is manually given when spawning.</p>
<p>Note, it is difficult to guarantee a ‚Äúbi-bind‚Äù Pod in an arbitrary flow. Depending on the topology, the input/output socket may switch the role between ‚Äúbind‚Äù and ‚Äúconnect‚Äù. Implementing heuristics to maximize the chance that a remote Pod enjoys  ‚Äúbi-bind‚Äù may be possible, but is tedious and not very cost-effective.</p>
<p>As the conclusion, <strong>we decide not to support remote Pod in this JEP.</strong> All pods are limited to run locally.</p>
</div>
<div class="section" id="run-pods-in-their-own-container">
<h3><a class="toc-backref" href="#id8">Run pods in their own container</a><a class="headerlink" href="#run-pods-in-their-own-container" title="Permalink to this headline">¬∂</a></h3>
<dl class="confval">
<dt id="confval-image">
<code class="sig-name descname">image</code><a class="headerlink" href="#confval-image" title="Permalink to this definition">¬∂</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">image</span></code> describes the docker image that a <code class="docutils literal notranslate"><span class="pre">Pod</span></code> will be running with, e.g. <code class="docutils literal notranslate"><span class="pre">jina-encoder:nlp-bert:0.1</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

<p>First, we may need a good naming convention for the image tag. This needs to be discussed separately.</p>
<p>Let‚Äôs look at the following example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">Flow</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="s1">&#39;./encode.yml&#39;</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="s1">&#39;jina-encoder:cv-blah&#39;</span><span class="p">)</span>  <span class="c1"># -&gt; p1 runs in the container</span>
            <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;p2&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>All keyword arguments of <cite>p1</cite> now forward to <code class="docutils literal notranslate"><span class="pre">jina-encoder:cv-blah</span></code>. So instead of running process/thread in</p>
<p>It should run the Pod via <strong class="command">docker run -v jina-encoder:cv-blah --name p1 --yaml_path ./encode.yml</strong>.</p>
<p>But how to handle multiple replicas?</p>
<p>Note a Pod can contain multiple Peas when <code class="docutils literal notranslate"><span class="pre">--replicas</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>. If a Pod is wrapped in a container, then that means all its Peas, including the head and tail are all running in the container.</p>
<p>This poses a problem. The head and tail of a Pod can be eliminated during the <code class="xref py py-func docutils literal notranslate"><span class="pre">jina.flow.Flow.build()</span></code>. The structure of a Pod is ‚Äúbroken‚Äù because of this. We can of course omit the heuristic of topology optimization when <code class="docutils literal notranslate"><span class="pre">image</span></code> and <code class="docutils literal notranslate"><span class="pre">replicas</span></code> are both set. But before that, let‚Äôs first think what does it mean when a user specify <code class="docutils literal notranslate"><span class="pre">replicas</span></code> and <code class="docutils literal notranslate"><span class="pre">image</span></code> at the same time. Does it mean running one container but having <code class="docutils literal notranslate"><span class="pre">replicas</span></code> number of peas inside the container, or does it mean running <code class="docutils literal notranslate"><span class="pre">replicas</span></code> number of containers? The following figure illustrates the difference.</p>
<a class="reference internal image-reference" href="../../../_images/JEP2-Pod-Container.svg"><img alt="../../../_images/JEP2-Pod-Container.svg" class="align-center" src="../../../_images/JEP2-Pod-Container.svg" width="60%" /></a>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>In the Docker documentation, <code class="docutils literal notranslate"><span class="pre">replicas</span></code> is defined as ‚Äúthe number of containers that should be running at any given time‚Äù. We follow this definition and choose the last interpretation in the figure above. This should offer us more flexibility and consistency with Docker and Kubernetes API.</p>
<p><strong>Each container contains a ``Pea``, not a ``Pod``, therefore a ``Pea`` should provide a CLI with the some additional argument.</strong></p>
<dl class="confval">
<dt id="confval-replica_id">
<code class="sig-name descname">replica_id</code><a class="headerlink" href="#confval-replica_id" title="Permalink to this definition">¬∂</a></dt>
<dd><p>A <code class="docutils literal notranslate"><span class="pre">Pea</span></code> is always unary, it has no replicas. <code class="docutils literal notranslate"><span class="pre">replicas_id</span></code> represent an integer index that its parent <code class="docutils literal notranslate"><span class="pre">Pod</span></code> assign to it. <code class="docutils literal notranslate"><span class="pre">replica_id</span></code> is defined on the <code class="docutils literal notranslate"><span class="pre">Pea</span></code> level.</p>
</dd></dl>

<dl class="confval">
<dt id="confval-image">
<code class="sig-name descname">image</code><a class="headerlink" href="#confval-image" title="Permalink to this definition">¬∂</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">image</span></code> is defined at the <code class="docutils literal notranslate"><span class="pre">Pod</span></code> level. It describes all non-head and non-tail peas should be running with. If it is specified, then the following code needs to behave differently:</p>
</dd></dl>

<p>These lines should start Docker containers with args followed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Pod</span></code> will inherit these CLI arguments.</p>
</div>
<div class="section" id="new-cli-argument">
<h3><a class="toc-backref" href="#id9">New CLI argument</a><a class="headerlink" href="#new-cli-argument" title="Permalink to this headline">¬∂</a></h3>
<p>..confval:: hostname</p>
<blockquote>
<div><p>Useful when the current Pea socket is <code class="docutils literal notranslate"><span class="pre">BIND</span></code> and other Peas <code class="docutils literal notranslate"><span class="pre">CONNECT</span></code> to it,</p>
<ul class="simple">
<li><p>a remote IP address (72.214.121.283), remote</p></li>
<li><p>The DNS name (e.g. encoder-1), local/remote</p></li>
<li><p>0.0.0.0, local</p></li>
<li><p>host.docker.internal, local</p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</div></blockquote>
<p>..confval:: remote</p>
<blockquote>
<div><p>To tell if the Pea is running remotely or locally</p>
<dl class="field-list simple">
<dt class="field-odd">type</dt>
<dd class="field-odd"><p>bool</p>
</dd>
</dl>
</div></blockquote>
<dl class="confval">
<dt id="confval-image">
<code class="sig-name descname">image</code><a class="headerlink" href="#confval-image" title="Permalink to this definition">¬∂</a></dt>
<dd><p>If set then the Pea is running inside the docker</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>str</p>
</dd>
</dl>
</dd></dl>

</div>
</div>
<div class="section" id="specification">
<h2><a class="toc-backref" href="#id18">Specification</a><a class="headerlink" href="#specification" title="Permalink to this headline">¬∂</a></h2>
<p>If the <code class="docutils literal notranslate"><span class="pre">socket_type</span></code> is BIND, then it is always bind to <code class="docutils literal notranslate"><span class="pre">tcp://0.0.0.0:port</span></code>. The key problem is to determine the <code class="docutils literal notranslate"><span class="pre">host_in</span></code> and <code class="docutils literal notranslate"><span class="pre">host_out</span></code> when the <code class="docutils literal notranslate"><span class="pre">socket_type</span></code> is CONNECT.</p>
<p>Logic when connecting, the Pea that opens a BIND socket is <em>Server</em>, and the Pea connects to it as <em>Client</em>:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 13%" />
<col style="width: 14%" />
<col style="width: 13%" />
<col style="width: 23%" />
<col style="width: 26%" />
</colgroup>
<tbody>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><p>BIND</p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td><p>Local</p></td>
<td></td>
<td><p>Remote</p></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td><p>Docker</p></td>
<td><p>Host Thread/Process</p></td>
<td><p>Docker</p></td>
<td><p>Host Thread/Process</p></td>
</tr>
<tr class="row-even"><td><p>CONNECT</p></td>
<td><p>Local</p></td>
<td><p>Docker</p></td>
<td><p>host.docker.internal*</p></td>
<td><p>host.docker.internal</p></td>
<td><p>hostname_of_BIND</p></td>
<td><p>hostname_of_BIND</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>Host Thread/Process</p></td>
<td><p>0.0.0.0</p></td>
<td><p>0.0.0.0</p></td>
<td><p>hostname_of_BIND</p></td>
<td><p>hostname_of_BIND</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>Remote</p></td>
<td><p>Docker</p></td>
<td><p>hostname_of_BIND</p></td>
<td><p>hostname_of_BIND</p></td>
<td><p>Same Remote? Then follow local-local</p></td>
<td><p>Different Remote?Then follow remote-local</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td><p>Host Thread/Process</p></td>
<td><p>hostname_of_BIND</p></td>
<td><p>hostname_of_BIND</p></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="section" id="a-minimum-jina-docker-contianer">
<h3><a class="toc-backref" href="#id11">A minimum Jina Docker Contianer</a><a class="headerlink" href="#a-minimum-jina-docker-contianer" title="Permalink to this headline">¬∂</a></h3>
</div>
</div>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id19">Specification</a><a class="headerlink" href="#id2" title="Permalink to this headline">¬∂</a></h2>
</div>
<div class="section" id="backwards-compatibility">
<h2><a class="toc-backref" href="#id20">Backwards Compatibility</a><a class="headerlink" href="#backwards-compatibility" title="Permalink to this headline">¬∂</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
    
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
        <a href="../jep-3/index.html" class="btn btn-neutral float-right" title="JEP 3 ‚Äî Adding support for multi-fields search"
           accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
        
        
        <a href="../jep-1/index.html" class="btn btn-neutral float-left" title="JEP 1 ‚Äî Redesigning Driver and its relation to Executor"
           accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
        
    </div>
    

    <hr/>

    <div role="contentinfo">
        <nav class="devsite-footer-linkboxes nocontent" aria-label="Footer links">

            <ul class="devsite-footer-linkboxes-list">

                <li class="devsite-footer-linkbox ">
                    <h3 class="devsite-footer-linkbox-heading no-link">Stay connected</h3>
                    <ul class="devsite-footer-linkbox-list">

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">

                                <i class="fab fa-github"></i> GitHub

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://www.linkedin.com/company/jinaai/" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">

                                <i class="fab fa-linkedin"></i> LinkedIn

                            </a>

                        </li>



                        <li class="devsite-footer-linkbox-item">

                            <a href="https://twitter.com/JinaAI_" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">

                                <i class="fab fa-twitter"></i> Twitter

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://www.youtube.com/c/JinaAI" class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">

                                <i class="fab fa-youtube"></i> YouTube

                            </a>

                        </li>

                    </ul>
                </li>

                <li class="devsite-footer-linkbox ">
                    <h3 class="devsite-footer-linkbox-heading no-link">Support</h3>
                    <ul class="devsite-footer-linkbox-list">
                        <li class="devsite-footer-linkbox-item">

                            <a href="https://slack.jina.ai"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 3)">

                                <i class="fab fa-slack"></i> Slack community

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina/issues"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 1)">

                                Issue tracker

                            </a>

                        </li>

                        <li class="devsite-footer-linkbox-item">

                            <a href="https://github.com/jina-ai/jina/blob/master/CHANGELOG.md"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 2)">

                                Release notes

                            </a>

                        </li>



                        <li class="devsite-footer-linkbox-item">

                            <a href="https://career.jina.ai"
                               class="devsite-footer-linkbox-link gc-analytics-event"
                               data-category="Site-Wide Custom Events" data-label="Footer Link (index 4)">

                                Career@Jina AI

                            </a>

                        </li>


                    </ul>
                </li>

            </ul>

        </nav>
        <p>
            
            &copy; Copyright Jina AI Limited. All rights reserved.
            <span class="lastupdated">
        Last updated on Jan 29, 2021.
      </span>

        </p>
    </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });

      function showhide_navbar() {
      var x = document.getElementsByClassName("wy-nav-side")[0];
      var y = document.getElementsByClassName("wy-nav-content-wrap")[0];
      var z = document.getElementById("showhide-navbar-btn");
      if (x.style.display === "none") {
        x.style.display = "block";
        y.style.marginLeft = "300px";
        z.style.left = "300px";
      } else {
        x.style.display = "none";
        y.style.marginLeft = "0";
        z.style.left = "0px";
      }
    }

  </script>

  <!-- Search box becomes active when you press the slash(/) key anywhere on the page-->
  <script>
    const body = document.querySelector('body');
    const searchBox = document.querySelector('form').querySelector('input[type="text"]');

    body.addEventListener('keyup', event => {
      event.preventDefault()
      if (event.key === '/') {
        searchBox.focus();
      }
    });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-164627626-3', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>